name: Deploy to Main

# âœ… ë¸Œëœì¹˜ ì„ íƒ
on:
  push:
    branches:
      - main

# âœ… ë¹Œë“œë˜ëŠ” ì„œë²„ ëª…ì‹œ
jobs:
  build-and-push:
    runs-on: ubuntu-24.04

    steps:
      # âœ… repo checkout
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… JDK 17 ì…‹íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ(JAR ìƒì„±)
      - name: Build Spring Boot project to JAR
        run:  chmod +x gradlew && ./gradlew clean build -x test

      # âœ… ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ(Docker image ìƒì„±)
      - name: Build Docker image
        run: |
          docker build -t websocket-app:latest .

      # âœ… ë„ì»¤ ì´ë¯¸ì§€ë¥¼ tar íŒŒì¼ë¡œ ì €ì¥(ì „ì†¡ìš©)
      - name: Save Docker image as tar
        run: docker save websocket-app > websocket-app.tar

      # âœ… tar íŒŒì¼ ì„œë²„ì— ì „ì†¡
      - name: Copy tar to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          source: "websocket-app.tar"
          target: "~/app"
          debug: 'true'

      # âœ… docker-compose.yml íŒŒì¼ ì—…ë°ì´íŠ¸
      - name: Update docker-compose.yml
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          source: "docker-compose.yml"
          target: "~/app"
          debug: 'true'

      # âœ… ì´ë¯¸ì§€ ë¡œë“œ + docker compose ë¡œ websocket-app ë§Œ ì¬ì‹œì‘
      - name: Reload SpringBoot container via docker-compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd ~/app
            
            echo "ğŸ“¦ Load new image"
            sudo docker load < websocket-app.tar

            echo "ğŸ§¼ Remove previous containers"
            sudo docker-compose stop server_a server_b server_c
            sudo docker-compose rm -f server_a server_b server_c

            echo "ğŸš€ Start containers fresh"
            sudo docker-compose up -d redis 
            sleep 30
            
            sudo docker-compose up -d server_a
            sleep 30
            
            sudo docker-compose up -d server_b
            sleep 30
            
            sudo docker-compose up -d server_c

            echo "âœ… Compose containers restarted"
          debug: 'true'