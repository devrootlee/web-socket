<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•™ìƒ í™”ë©´</title>
</head>
<body>
<h2>ğŸ“ í•™ìƒ(WebSocket + Redis Pub/Sub)</h2>

<p>ì„œë²„ ì£¼ì†Œ (ìë™ ê°ì§€ë¨): <code id="serverUrlDisplay"></code></p>

<label>Room ID: <input type="text" id="roomId" value="FTYXPM" /></label><br>
<label>í•™ìƒ ID: <input type="text" id="studentId" value="student" /></label><br>
<label>ë©”ì‹œì§€ ë‚´ìš©: <input type="text" id="msg" style="width: 300px;" /></label><br>

<button onclick="connect()">ì›¹ì†Œìº£ ì—°ê²°</button>
<button onclick="send()">ë©”ì‹œì§€ ì „ì†¡</button>
<button onclick="disconnect()">ì›¹ì†Œìº£ ì¢…ë£Œ</button>

<pre id="log" style="border:1px solid #ccc; padding:10px; margin-top:20px; height:300px; overflow:auto;"></pre>

<script>
    let socket;

    window.onload = () => {
        const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const baseUrl = `${wsProtocol}://${location.host}/ws`;
        document.getElementById("serverUrlDisplay").textContent = baseUrl;
    };

    function get(id) {
        return document.getElementById(id).value;
    }

    function log(msg) {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
    }

    function buildWsUrl() {
        const userId = encodeURIComponent(get("studentId"));
        const userType = "student";
        const roomId = get("roomId");

        const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
        return `${wsProtocol}://${location.host}/ws?userId=${userId}&userType=${userType}&roomId=${roomId}`;
    }

    function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            log("âš ï¸ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìƒˆ ì—°ê²° ì „ì— ê¸°ì¡´ ì—°ê²°ì„ ë‹«ì•„ì£¼ì„¸ìš”.");
            return;
        }

        const wsUrl = buildWsUrl();
        log(`ğŸ”Œ ì„œë²„ ì—°ê²° ì‹œë„: ${wsUrl}`);
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            log("âœ… WebSocket ì—°ê²°ë¨");
            document.getElementById("roomId").disabled = true;
            document.getElementById("studentId").disabled = true;
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.messageType === "leave" && data.senderType === "teacher") {
                log("ğŸ›‘ êµì‚¬ê°€ í‡´ì¥í–ˆìŠµë‹ˆë‹¤. ì„¸ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                socket.close();
                return;
            }

            log(`ğŸ“¥ ìˆ˜ì‹ ë¨ (${data.sender}): ${data.message}`);
        };

        socket.onclose = () => {
            log("âŒ WebSocket ì—°ê²° ì¢…ë£Œë¨");
            document.getElementById("roomId").disabled = false;
            document.getElementById("studentId").disabled = false;
        };

        socket.onerror = (error) => {
            log("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: " + (error.message || "WebSocket ì˜¤ë¥˜"));
        };
    }

    function send() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log("âš ï¸ WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const roomId = get("roomId");
        const sender = get("studentId");
        const message = {
            room: "room:" + roomId,
            senderType: "student",
            sender: sender,
            targetType: "teacher",
            messageType: "send",
            message: get("msg")
        };

        socket.send(JSON.stringify(message));
        log(`ğŸ“¤ ë³´ëƒ„ (${sender} â†’ êµì‚¬): ${message.message}`);
    }

    function disconnect() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log("âš ï¸ ì¢…ë£Œí•  WebSocket ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        socket.close(1000, "ì‚¬ìš©ì ìˆ˜ë™ ì¢…ë£Œ");
        log("ğŸ”’ WebSocket ìˆ˜ë™ ì¢…ë£Œ ìš”ì²­ë¨");
    }
</script>
</body>
</html>
