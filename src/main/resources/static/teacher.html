<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµì‚¬ - ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸</title>
    <style>
        #container {
            display: flex;
            gap: 20px;
        }
        #log {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
        }
        #participants {
            width: 200px;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
<h2>ğŸ§‘â€ğŸ« êµì‚¬ - ë©”ì‹œì§€ ì „ì†¡ (WebSocket + Redis Pub/Sub)</h2>

<label>ì„œë²„ IP: <input type="text" id="serverIp" value="localhost" /></label><br>
<label>ì„œë²„ í¬íŠ¸: <input type="text" id="serverPort" value="8080" /></label><br>
<label>Room ID: <input type="text" id="roomId" value="FTYXPM" /></label><br>
<label>êµì‚¬ ì´ë¦„: <input type="text" id="senderName" value="ë‹´ì„ì„ ìƒë‹˜" /></label><br>
<label>ì´ë¯¸ì§€ URL: <input type="text" id="msg" style="width: 500px;" /></label><br>

<button onclick="connect()">Connect</button>
<button onclick="send()">ë©”ì‹œì§€ ì „ì†¡</button>

<div id="container">
    <pre id="log"></pre>
    <div id="participants">
        <strong>ğŸ‘¥ ì°¸ê°€ì</strong>
        <ul id="participantList"></ul>
    </div>
</div>

<script>
    let socket;
    const participants = new Set();

    function get(id) {
        return document.getElementById(id).value;
    }

    function log(msg) {
        const logBox = document.getElementById("log");
        logBox.textContent += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
    }

    function updateParticipantList() {
        const list = document.getElementById("participantList");
        list.innerHTML = "";
        [...participants].forEach(name => {
            const li = document.createElement("li");
            li.textContent = name;
            list.appendChild(li);
        });
    }

    function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            log("âš ï¸ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìƒˆ ì—°ê²° ì „ì— ê¸°ì¡´ ì—°ê²°ì„ ë‹«ì•„ì£¼ì„¸ìš”.");
            return;
        }

        const userId = "TEACHER001";
        const userType = "teacher";
        const roomId = get("roomId");
        const ip = get("serverIp");
        const port = get("serverPort");

        const wsUrl = `ws://${ip}:${port}/ws?userId=${userId}&userType=${userType}&roomId=${roomId}`;
        log(`ğŸ”Œ ì„œë²„ ì—°ê²° ì‹œë„: ${wsUrl}`);
        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            log("âœ… WebSocket ì—°ê²°ë¨");
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "join") {
                log(`ğŸŸ¢ ${data.sender} ì…ì¥`);
                participants.add(data.sender);
                updateParticipantList();
            } else if (data.senderType === "student" && data.messageType === "leave") {
                log(`ğŸ”´ ${data.sender} í‡´ì¥`);
                participants.delete(data.sender);
                updateParticipantList();
            } else {
                log(`ğŸ“¥ ìˆ˜ì‹ ë¨ (${data.sender}): ${data.message}`);
            }
        };

        socket.onclose = () => {
            log("âŒ WebSocket ì—°ê²° ì¢…ë£Œë¨");
        };

        socket.onerror = (err) => {
            log("ğŸš¨ WebSocket ì˜¤ë¥˜: " + err.message);
        };
    }

    function send() {
        const roomId = get("roomId");
        const timestamp = Date.now();
        const message = {
            room: "room:" + roomId,
            senderType: "teacher",
            sender: "TEACHER001",
            targetType: "student",
            messageType: "send",
            message: get("msg")
        };

        socket.send(JSON.stringify(message));
        log(`ğŸ“¤ [${timestamp}] ë©”ì‹œì§€ ì „ì†¡ë¨`);
    }
</script>
</body>
</html>
